Reference: http://docs.ceph.com/docs/mimic/install/manual-deployment/

# Build from source.
git submodule update --init --recursive
./install-deps.sh
./do_cmake.sh
cd build
make
sudo make install

# 1 mon, many osds.
# All processes are running by root.

# Launching monitor daemon.
# ssh to monitor node.
sudo mkdir -p /etc/ceph
sudo vim /etc/ceph/ceph.conf

# Copy and paste it into the ceph configuration file.
[global]
fsid = c16c8ea8-31ab-4940-b971-d2edf940de1c
mon_initial_members = cephnode1
mon_host = 192.168.1.31
auth_cluster_required = cephx
auth_service_required = cephx
auth_client_required = cephx

sudo -u ceph ceph-authtool --create-keyring /tmp/ceph.mon.keyring --gen-key -n mon. --cap mon 'allow *'
sudo ceph-authtool --create-keyring /etc/ceph/ceph.client.admin.keyring --gen-key -n client.admin --set-uid=0 --cap mon 'allow *' --cap osd 'allow *' --cap mds 'allow *' --cap mgr 'allow *'
sudo mkdir -p /var/lib/ceph/bootstrap-osd
sudo chown -R ceph:ceph /var/lib/ceph
sudo -u ceph ceph-authtool --create-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring --gen-key -n client.bootstrap-osd --cap mon 'profile bootstrap-osd'
sudo ceph-authtool /tmp/ceph.mon.keyring --import-keyring /etc/ceph/ceph.client.admin.keyring
sudo ceph-authtool /tmp/ceph.mon.keyring --import-keyring /var/lib/ceph/bootstrap-osd/ceph.keyring
sudo -u ceph monmaptool --create --add cephnode1 192.168.1.31 --fsid c16c8ea8-31ab-4940-b971-d2edf940de1c /tmp/monmap
sudo -u ceph mkdir -p /var/lib/ceph/mon/ceph-cephnode1
sudo -u ceph ceph-mon --mkfs -i cephnode1 --monmap /tmp/monmap --keyring /tmp/ceph.mon.keyring
sudo -u ceph touch /var/lib/ceph/mon/ceph-cephnode1/done
sudo chmod +r /etc/ceph/ceph.client.admin.keyring

# Copy systemd files into the /lib/systemd/system directory at all ceph nodes.
cp systemd/system/* /lib/systemd/system/

# Run ceph monitor in background.
sudo systemctl start ceph-mon@cephnode1

# Check ceph monitor activated.
ps aux | grep ceph-mon

# Run ceph mgr.
sudo -u ceph mkdir -p /var/lib/ceph/mgr/ceph-cephnode1
ceph auth get-or-create mgr.cephnode1 mon 'allow profile mgr' osd 'allow *' mds 'allow *' > keyring
sudo chmod 600 keyring
sudo mv keyring /var/lib/ceph/mgr/ceph-cephnode1/
sudo chown -R ceph:ceph /var/lib/ceph/mgr
sudo systemctl start ceph-mgr@cephnode1

# Check ceph status (there must be 'cold-store' in result)
ceph -s

# Gather keys from another nodes.
sudo scp /etc/ceph/* cephnode2@cephnode2:~
sudo scp /var/lib/ceph/bootstrap-osd/ceph.keyring cephnode2@cephnode2:~
ssh cephnode2

# Copy keyring into bootstrap-osd
sudo mkdir -p /var/lib/ceph/bootstrap-osd
sudo mv ~/ceph.keyring /var/lib/ceph/bootstrap-osd/
sudo chown -R ceph:ceph /var/lib/ceph

# Check lv list.
sudo lvs 
# If there is a lv in list, remove it.
sudo lvremove {VG-name}
# Check ceph is mounted.
df -h
# If ceph exists, umount it.


# Copy ceph.conf and admin.keyring
sudo mkdir -p /etc/ceph
sudo mv ~/ceph.client.admin.keyring /etc/ceph/
sudo mv ~/ceph.conf /etc/ceph/

# Deploy osd.
sudo -u ceph mkdir -p /var/lib/ceph/osd
sudo ceph-volume lvm zap /dev/sda
sudo ceph-volume lvm create --data /dev/sda

# Check the ceph status.
ceph -s


### UNINSTALL

# Stop the background service
sudo systemctl stop ceph-mon

# [MON] Remove files that can't be removed by uninstall
sudo rm /tmp/monmap
sudo rm /tmp/ceph.mon.keyring

# [OSD] 
sudo umount /dev/sda
sudo lvs              # check
sudo lvremove {VG-name}
sudo ceph-volume lvm zap

# Uninstall each node at build directory
sudo make uninstall

# In user 'park' at directory 'ceph-cluster', do ceph-deploy purge, purgedata, forgetkeys
ceph-deploy purge cephnode1 cephnode2 cepnhode3
ceph-deploy purgedata cephnode1 cephnode2 cepnhode3
ceph-deploy forgetkeys
rm *
